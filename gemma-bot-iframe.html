<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>بوت المحاسبة</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            background-color: transparent;
        }

        .bot-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(to right, #1a237e, #0d47a1);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 9999;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .bot-toggle:hover {
            transform: scale(1.1);
        }

        .bot-container {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            overflow: hidden;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            transform: scale(0);
            transform-origin: bottom left;
            transition: transform 0.3s ease;
        }

        .bot-container.active {
            transform: scale(1);
        }

        .bot-header {
            background: linear-gradient(to right, #1a237e, #0d47a1);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .bot-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }

        .bot-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
        }

        .bot-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .bot-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }

        .bot-message.user {
            align-self: flex-end;
        }

        .bot-message.bot {
            align-self: flex-start;
        }

        .message-content {
            padding: 10px 15px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .bot-message.user .message-content {
            background: #e9f5ff;
            color: #333;
            border-top-right-radius: 0;
        }

        .bot-message.bot .message-content {
            background: #f0f0f0;
            color: #333;
            border-top-left-radius: 0;
        }

        .bot-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid #eee;
        }

        #bot-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .bot-send {
            background: linear-gradient(to right, #1a237e, #0d47a1);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .options-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .bot-option {
            background: #e9f5ff;
            border: none;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .bot-option:hover {
            background: #d0e8ff;
            transform: translateY(-2px);
        }

        .typing-indicator .message-content {
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 50px;
        }

        .typing-indicator .message-content span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: #888;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out both;
        }

        .typing-indicator .message-content span:nth-child(1) {
            animation-delay: 0s;
        }

        .typing-indicator .message-content span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator .message-content span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0% { transform: scale(0); }
            50% { transform: scale(1); }
            100% { transform: scale(0); }
        }
    </style>
</head>
<body>
    <!-- زر تبديل البوت -->
    <div class="bot-toggle">
        <i class="fas fa-comments"></i>
    </div>

    <!-- نافذة البوت -->
    <div class="bot-container">
        <div class="bot-header">
            <h3>مساعد المحاسبة (Gemma 3 27B)</h3>
            <button class="bot-close"><i class="fas fa-times"></i></button>
        </div>
        <div class="bot-messages" id="bot-messages"></div>
        <div class="bot-input-container">
            <input type="text" id="bot-input" placeholder="اكتب رسالتك هنا...">
            <button class="bot-send"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script>
    // بوت المحاسبة باستخدام Gemma 3 27B
    const API_KEY = "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";
    const MODEL = "Gemma 3 27B";

    // معلومات الشركة
    const companyInfo = {
        name: "آفاق للمحاسبة",
        owner: "أيمن الصلوي",
        phone: "00967777991788",
        whatsapp: "00967777991788",
        email: "aymanalsalawi@gmail.com",
        location: "المملكة العربية السعودية",
        workHours: "من الأحد إلى الخميس: 9 صباحاً - 6 مساءً"
    };

    // قائمة الخدمات
    const services = {
        accounting: {
            title: "مسك الدفاتر المحاسبية",
            price: "يبدأ من 1500 ريال شهرياً",
            description: "خدمات مسك الدفاتر المحاسبية بدقة عالية، تسجيل المعاملات المالية، وإعداد القيود المحاسبية"
        },
        tax: {
            title: "الخدمات الضريبية",
            price: "يبدأ من 2000 ريال شهرياً",
            description: "إعداد الإقرارات الضريبية، التخطيط الضريبي، والتعامل مع الجهات الضريبية المختلفة"
        },
        audit: {
            title: "خدمات المراجعة والتدقيق",
            price: "يبدأ من 3000 ريال",
            description: "مراجعة وتدقيق الحسابات، إعداد التقارير المالية، وتقييم نظم الرقابة الداخلية"
        },
        consulting: {
            title: "الاستشارات المالية",
            price: "يبدأ من 1000 ريال للجلسة",
            description: "تقديم استشارات مالية متخصصة، تحليل الأداء المالي، ووضع الخطط المالية المستقبلية"
        }
    };

    // تهيئة البوت عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', () => {
        initializeBot();
    });

    // تهيئة البوت
    function initializeBot() {
        // إضافة الأحداث
        document.querySelector('.bot-toggle').addEventListener('click', toggleBot);
        document.querySelector('.bot-close').addEventListener('click', toggleBot);
        document.getElementById('bot-input').addEventListener('keypress', handleKeyPress);
        document.querySelector('.bot-send').addEventListener('click', sendMessage);

        // إضافة رسالة الترحيب
        setTimeout(() => {
            addMessage("مرحباً بك في آفاق للمحاسبة! أنا مساعدك المحاسبي المتخصص. يمكنني مساعدتك في استفساراتك حول مسك الدفاتر، الخدمات الضريبية والزكوية، إعداد القوائم المالية، التدقيق والمراجعة، والاستشارات المالية. كيف يمكنني مساعدتك اليوم؟", false);
            showOptions();
        }, 500);
    }

    // تبديل حالة البوت (مفتوح/مغلق)
    function toggleBot() {
        const botContainer = document.querySelector('.bot-container');
        const botToggle = document.querySelector('.bot-toggle');

        if (botContainer.classList.contains('active')) {
            botContainer.classList.remove('active');
            setTimeout(() => {
                botToggle.style.display = 'flex';
            }, 300);
        } else {
            botContainer.classList.add('active');
            botToggle.style.display = 'none';
        }
    }

    // إضافة رسالة إلى المحادثة
    function addMessage(message, isUser = false) {
        const botMessages = document.getElementById('bot-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `bot-message ${isUser ? 'user' : 'bot'}`;
        messageDiv.innerHTML = `
            <div class="message-content">
                ${message}
            </div>
        `;
        botMessages.appendChild(messageDiv);
        botMessages.scrollTop = botMessages.scrollHeight;
    }

    // عرض خيارات للمستخدم
    function showOptions() {
        const options = [
            '1️⃣ خدماتنا المحاسبية',
            '2️⃣ الخدمات الضريبية والزكوية',
            '3️⃣ استفسارات محاسبية شائعة',
            '4️⃣ طلب استشارة مجانية',
            '5️⃣ التواصل مع فريق المحاسبة'
        ];

        const optionsHtml = options.map(option =>
            `<button class="bot-option" onclick="handleOption('${option}')">${option}</button>`
        ).join('');

        addMessage(`كيف يمكنني مساعدتك في استفساراتك المحاسبية؟
            <div class="options-container">${optionsHtml}</div>`, false);
    }

    // معالجة الخيارات
    function handleOption(option) {
        switch(option[0]) {
            case '1':
                // خدماتنا المحاسبية
                let accountingServicesText = "📊 خدماتنا المحاسبية المتكاملة:\n\n";
                accountingServicesText += `📌 ${services.accounting.title}\n💰 ${services.accounting.price}\n${services.accounting.description}\n\n`;
                accountingServicesText += `📌 ${services.audit.title}\n💰 ${services.audit.price}\n${services.audit.description}\n\n`;
                accountingServicesText += "نقدم أيضاً خدمات إضافية تشمل:\n";
                accountingServicesText += "- إعداد وتحليل القوائم المالية\n";
                accountingServicesText += "- تصميم وتطبيق النظم المحاسبية\n";
                accountingServicesText += "- تدريب الكوادر المحاسبية\n";
                accountingServicesText += "- تقديم تقارير مالية دورية\n";

                addMessage(accountingServicesText);

                // إضافة خيارات فرعية
                const accountingSubOptions = [
                    'مسك الدفاتر المحاسبية',
                    'إعداد القوائم المالية',
                    'التدقيق والمراجعة'
                ];

                const subOptionsHtml = accountingSubOptions.map(option =>
                    `<button class="bot-option" onclick="handleSubOption('${option}')">${option}</button>`
                ).join('');

                setTimeout(() => {
                    addMessage(`هل تريد معلومات أكثر تفصيلاً عن أي من خدماتنا المحاسبية؟
                        <div class="options-container">${subOptionsHtml}</div>`, false);
                }, 1000);
                break;

            case '2':
                // الخدمات الضريبية والزكوية
                let taxServicesText = "💼 الخدمات الضريبية والزكوية:\n\n";
                taxServicesText += `📌 ${services.tax.title}\n💰 ${services.tax.price}\n${services.tax.description}\n\n`;
                taxServicesText += "تشمل خدماتنا الضريبية والزكوية:\n";
                taxServicesText += "- التسجيل في ضريبة القيمة المضافة\n";
                taxServicesText += "- إعداد وتقديم الإقرارات الضريبية والزكوية\n";
                taxServicesText += "- تمثيل العملاء أمام الهيئات الضريبية\n";
                taxServicesText += "- التخطيط الضريبي وتحسين الوضع الضريبي\n";
                taxServicesText += "- حل النزاعات الضريبية\n";
                taxServicesText += "- الاستشارات الضريبية المتخصصة\n";

                addMessage(taxServicesText);

                // إضافة خيارات فرعية
                const taxSubOptions = [
                    'ضريبة القيمة المضافة',
                    'الزكاة',
                    'ضريبة الدخل'
                ];

                const taxOptionsHtml = taxSubOptions.map(option =>
                    `<button class="bot-option" onclick="handleSubOption('${option}')">${option}</button>`
                ).join('');

                setTimeout(() => {
                    addMessage(`هل تريد معلومات أكثر تفصيلاً عن أي من الخدمات الضريبية؟
                        <div class="options-container">${taxOptionsHtml}</div>`, false);
                }, 1000);
                break;

            case '3':
                // استفسارات محاسبية شائعة
                const faqOptions = [
                    'كيف تسجل المعاملات المحاسبية؟',
                    'ما هي القوائم المالية الأساسية؟',
                    'كيف تحسب ضريبة القيمة المضافة؟',
                    'ما هي المعايير المحاسبية المعتمدة؟',
                    'متى يجب تقديم الإقرارات الضريبية؟'
                ];

                const faqOptionsHtml = faqOptions.map(option =>
                    `<button class="bot-option" onclick="handleSubOption('${option}')">${option}</button>`
                ).join('');

                addMessage(`إليك بعض الاستفسارات المحاسبية الشائعة:
                    <div class="options-container">${faqOptionsHtml}</div>`, false);
                break;

            case '4':
                // طلب استشارة مجانية
                addMessage("يسعدنا تقديم استشارة محاسبية مجانية! يرجى إخبارنا بالتفاصيل التالية:");
                setTimeout(() => {
                    addMessage("1. اسم المنشأة\n2. نوع النشاط\n3. طبيعة الاستفسار المحاسبي\n4. رقم الجوال للتواصل", false);

                    // إضافة خيارات لنوع الاستشارة
                    const consultationOptions = [
                        'استشارة محاسبية',
                        'استشارة ضريبية',
                        'استشارة زكوية',
                        'استشارة مالية'
                    ];

                    const consultationHtml = consultationOptions.map(option =>
                        `<button class="bot-option" onclick="handleSubOption('${option}')">${option}</button>`
                    ).join('');

                    setTimeout(() => {
                        addMessage(`ما نوع الاستشارة التي تحتاجها؟
                            <div class="options-container">${consultationHtml}</div>`, false);
                    }, 500);
                }, 500);
                break;

            case '5':
                // التواصل مع فريق المحاسبة
                addMessage(`📞 للتواصل مع فريق المحاسبة المتخصص:
                    \n☎️ هاتف: ${companyInfo.phone}
                    \n📱 واتساب: ${companyInfo.whatsapp}
                    \n📧 إيميل: ${companyInfo.email}
                    \n🏢 العنوان: ${companyInfo.location}
                    \n⏰ ساعات العمل: ${companyInfo.workHours}`);

                setTimeout(() => {
                    addMessage("يمكنك أيضاً حجز موعد مع أحد مستشارينا المحاسبين عبر الضغط على 'حجز موعد'", false);

                    const appointmentHtml = `<button class="bot-option" onclick="handleSubOption('حجز موعد')">حجز موعد</button>`;

                    setTimeout(() => {
                        addMessage(`<div class="options-container">${appointmentHtml}</div>`, false);
                    }, 500);
                }, 1000);
                break;
        }
    }

    // معالجة الخيارات الفرعية
    function handleSubOption(option) {
        // مسك الدفاتر المحاسبية
        if (option === 'مسك الدفاتر المحاسبية') {
            addMessage(`خدمة مسك الدفاتر المحاسبية تشمل:
                \n- تسجيل كافة المعاملات المالية اليومية
                \n- إعداد دفتر اليومية ودفتر الأستاذ
                \n- تسجيل المصروفات والإيرادات
                \n- إعداد ميزان المراجعة
                \n- تسوية الحسابات البنكية
                \n- إدارة حسابات المدينين والدائنين
                \n- إعداد تقارير مالية دورية
                \n- الامتثال للمعايير المحاسبية المعتمدة
                \n\n💰 السعر: ${services.accounting.price}`);
        }
        // إعداد القوائم المالية
        else if (option === 'إعداد القوائم المالية') {
            addMessage(`خدمة إعداد القوائم المالية تشمل:
                \n- إعداد الميزانية العمومية
                \n- إعداد قائمة الدخل
                \n- إعداد قائمة التدفقات النقدية
                \n- إعداد قائمة التغيرات في حقوق الملكية
                \n- إعداد الإيضاحات المتممة للقوائم المالية
                \n- تحليل النسب المالية
                \n- تقديم توصيات لتحسين الأداء المالي
                \n\n💰 السعر: يبدأ من 2500 ريال سنوياً حسب حجم المنشأة`);
        }
        // التدقيق والمراجعة
        else if (option === 'التدقيق والمراجعة') {
            addMessage(`خدمة التدقيق والمراجعة تشمل:
                \n- فحص وتقييم نظام الرقابة الداخلية
                \n- مراجعة السجلات والدفاتر المحاسبية
                \n- التحقق من صحة المعاملات المالية
                \n- مراجعة الالتزام بالمعايير المحاسبية
                \n- إصدار تقرير المراجعة
                \n- تقديم توصيات لتحسين النظام المحاسبي
                \n\n💰 السعر: ${services.audit.price}`);
        }
        // ضريبة القيمة المضافة
        else if (option === 'ضريبة القيمة المضافة') {
            addMessage(`خدمات ضريبة القيمة المضافة:
                \n- التسجيل في نظام ضريبة القيمة المضافة
                \n- إعداد وتقديم الإقرارات الضريبية الشهرية/الربع سنوية
                \n- احتساب ضريبة القيمة المضافة المستحقة والقابلة للخصم
                \n- تمثيل العملاء أمام هيئة الزكاة والضريبة والجمارك
                \n- حل المشكلات والنزاعات الضريبية
                \n- تقديم الاستشارات المتعلقة بضريبة القيمة المضافة
                \n\n💰 السعر: يبدأ من 1000 ريال شهرياً`);
        }
        // الزكاة
        else if (option === 'الزكاة') {
            addMessage(`خدمات الزكاة:
                \n- احتساب الوعاء الزكوي وفقاً للأنظمة المعتمدة
                \n- إعداد وتقديم الإقرارات الزكوية
                \n- تمثيل العملاء أمام هيئة الزكاة والضريبة والجمارك
                \n- الاستشارات المتعلقة بالزكاة
                \n- حل النزاعات الزكوية
                \n\n💰 السعر: يبدأ من 3000 ريال سنوياً`);
        }
        // ضريبة الدخل
        else if (option === 'ضريبة الدخل') {
            addMessage(`خدمات ضريبة الدخل:
                \n- احتساب ضريبة الدخل المستحقة
                \n- إعداد وتقديم الإقرارات الضريبية
                \n- التخطيط الضريبي لتقليل العبء الضريبي بطرق قانونية
                \n- تمثيل العملاء أمام هيئة الزكاة والضريبة والجمارك
                \n- حل النزاعات الضريبية
                \n\n💰 السعر: يبدأ من 3500 ريال سنوياً`);
        }
        // استفسارات محاسبية شائعة
        else if (option === 'كيف تسجل المعاملات المحاسبية؟') {
            addMessage(`لتسجيل المعاملات المحاسبية، يتم اتباع نظام القيد المزدوج:
                \n1. تحديد الحسابات المتأثرة بالمعاملة
                \n2. تحديد الحسابات المدينة والدائنة (مجموع المدين = مجموع الدائن)
                \n3. تسجيل القيد في دفتر اليومية مع التاريخ والشرح
                \n4. ترحيل القيد إلى دفتر الأستاذ

                \nمثال: عند شراء أصل بقيمة 10,000 ريال نقداً:
                \n- مدين: الأصل 10,000 ريال
                \n- دائن: النقدية 10,000 ريال`);
        }
        else if (option === 'ما هي القوائم المالية الأساسية؟') {
            addMessage(`القوائم المالية الأساسية تشمل:
                \n1. الميزانية العمومية (قائمة المركز المالي): تعرض أصول والتزامات وحقوق ملكية المنشأة في تاريخ معين.
                \n2. قائمة الدخل (قائمة الأرباح والخسائر): توضح إيرادات ومصروفات المنشأة وصافي الربح أو الخسارة خلال فترة زمنية محددة.
                \n3. قائمة التدفقات النقدية: توضح حركة النقد الداخل والخارج من المنشأة خلال فترة زمنية محددة.
                \n4. قائمة التغيرات في حقوق الملكية: توضح التغيرات في حقوق الملكية خلال فترة زمنية محددة.
                \n5. الإيضاحات المتممة للقوائم المالية: تقدم معلومات إضافية وتفصيلية عن بنود القوائم المالية.`);
        }
        else if (option === 'كيف تحسب ضريبة القيمة المضافة؟') {
            addMessage(`لحساب ضريبة القيمة المضافة (15% في السعودية):
                \n1. للإضافة على السعر: السعر × 0.15 = مبلغ الضريبة
                \nمثال: منتج سعره 100 ريال، مبلغ الضريبة = 100 × 0.15 = 15 ريال
                \nالسعر شامل الضريبة = 115 ريال

                \n2. لاستخراج الضريبة من إجمالي المبلغ: المبلغ الإجمالي × (15 ÷ 115) = مبلغ الضريبة
                \nمثال: منتج سعره شامل الضريبة 115 ريال، مبلغ الضريبة = 115 × (15 ÷ 115) = 15 ريال
                \nالسعر بدون ضريبة = 100 ريال`);
        }
        else if (option === 'ما هي المعايير المحاسبية المعتمدة؟') {
            addMessage(`المعايير المحاسبية المعتمدة في المملكة العربية السعودية:
                \n- المعايير الدولية للتقارير المالية (IFRS) للشركات المدرجة والمنشآت الكبيرة
                \n- المعيار الدولي للتقرير المالي للمنشآت الصغيرة ومتوسطة الحجم (IFRS for SMEs)

                \nتشمل هذه المعايير إرشادات حول:
                \n- الاعتراف بالإيرادات والمصروفات
                \n- قياس وتقييم الأصول والالتزامات
                \n- عرض القوائم المالية
                \n- الإفصاح عن المعلومات المالية

                \nيتم تحديث هذه المعايير بشكل دوري من قبل مجلس معايير المحاسبة الدولية (IASB).`);
        }
        else if (option === 'متى يجب تقديم الإقرارات الضريبية؟') {
            addMessage(`مواعيد تقديم الإقرارات الضريبية في السعودية:
                \n- ضريبة القيمة المضافة:
                  • شهرياً: للمنشآت التي تتجاوز توريداتها السنوية 40 مليون ريال
                  • ربع سنوياً: للمنشآت الأخرى
                  • يجب تقديم الإقرار خلال الشهر التالي للفترة الضريبية

                \n- ضريبة الدخل والزكاة:
                  • سنوياً خلال 120 يوماً من نهاية السنة المالية
                  • يمكن طلب تمديد لمدة شهر واحد بشروط محددة

                \nملاحظة: عدم تقديم الإقرارات في مواعيدها يعرض المنشأة لغرامات تأخير.`);
        }
        // حجز موعد
        else if (option === 'حجز موعد') {
            addMessage(`لحجز موعد مع أحد مستشارينا المحاسبين، يرجى تزويدنا بالمعلومات التالية:
                \n1. الاسم الكامل
                \n2. رقم الجوال
                \n3. البريد الإلكتروني
                \n4. نوع الاستشارة المطلوبة
                \n5. التاريخ والوقت المفضل للموعد

                \nسيقوم فريقنا بالتواصل معك لتأكيد الموعد خلال 24 ساعة.`);
        }
        // أنواع الاستشارات
        else if (option.includes('استشارة')) {
            addMessage(`شكراً لاختيارك ${option}. يرجى ترك بيانات التواصل الخاصة بك وسيقوم أحد مستشارينا المتخصصين بالتواصل معك خلال 24 ساعة لتقديم استشارة مجانية.`);
        }
        else {
            // للخيارات الأخرى غير المعرفة
            addMessage(`شكراً لاهتمامك بـ "${option}". سيقوم فريقنا المتخصص بالتواصل معك لتقديم معلومات مفصلة حول هذا الموضوع.`);
        }
    }

    // معالجة ضغط Enter
    async function handleKeyPress(event) {
        if (event.key === 'Enter') {
            await sendMessage();
        }
    }

    // إرسال رسالة
    async function sendMessage() {
        const userInput = document.getElementById('bot-input');
        const message = userInput.value.trim();

        if (message) {
            // إضافة رسالة المستخدم
            addMessage(message, true);

            // إظهار مؤشر الكتابة
            const botMessages = document.getElementById('bot-messages');
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'bot-message bot typing-indicator';
            typingIndicator.innerHTML = '<div class="message-content"><span></span><span></span><span></span></div>';
            botMessages.appendChild(typingIndicator);
            botMessages.scrollTop = botMessages.scrollHeight;

            try {
                // محاكاة الاتصال بالنموذج (لأغراض الاختبار)
                const response = await simulateGemmaResponse(message);

                // إزالة مؤشر الكتابة
                botMessages.removeChild(typingIndicator);

                // إضافة رد البوت
                addMessage(response);
            } catch (error) {
                // إزالة مؤشر الكتابة
                botMessages.removeChild(typingIndicator);

                // إضافة رسالة خطأ
                addMessage("عذراً، حدث خطأ في الاتصال. يرجى المحاولة مرة أخرى.");
                console.error(error);
            }

            userInput.value = '';
        }
    }

    // قاعدة المعرفة المحاسبية
    const accountingKnowledge = {
        // مفاهيم محاسبية أساسية
        "دفتر اليومية": "دفتر اليومية هو سجل محاسبي يتم فيه تسجيل المعاملات المالية بشكل يومي حسب تسلسل حدوثها. يتضمن تاريخ المعاملة، الحسابات المدينة والدائنة، المبالغ، والشرح المختصر للمعاملة.",
        "دفتر الأستاذ": "دفتر الأستاذ هو سجل محاسبي يتم فيه تجميع وتصنيف المعاملات المالية حسب الحسابات. يتم ترحيل القيود من دفتر اليومية إلى دفتر الأستاذ لتحديد رصيد كل حساب.",
        "القيد المزدوج": "نظام القيد المزدوج هو أساس المحاسبة الحديثة، حيث يتم تسجيل كل معاملة مالية في جانبين: مدين ودائن، بحيث يكون مجموع المدين يساوي مجموع الدائن.",
        "الميزانية العمومية": "الميزانية العمومية هي قائمة مالية تعرض أصول والتزامات وحقوق ملكية المنشأة في تاريخ معين. تعتمد على معادلة: الأصول = الالتزامات + حقوق الملكية.",
        "قائمة الدخل": "قائمة الدخل هي تقرير مالي يوضح إيرادات ومصروفات المنشأة خلال فترة زمنية محددة، وصافي الربح أو الخسارة الناتجة.",
        "التدفقات النقدية": "قائمة التدفقات النقدية توضح حركة النقد الداخل والخارج من المنشأة خلال فترة زمنية محددة، مقسمة إلى أنشطة تشغيلية واستثمارية وتمويلية.",
        "الإهلاك": "الإهلاك هو توزيع تكلفة الأصول الثابتة على عمرها الإنتاجي، ويتم احتسابه بعدة طرق منها القسط الثابت والقسط المتناقص.",
        "الجرد": "الجرد هو عملية حصر وتقييم الأصول والمخزون في تاريخ معين للتأكد من مطابقتها للسجلات المحاسبية.",

        // المعايير المحاسبية
        "المعايير المحاسبية": "المعايير المحاسبية هي مجموعة من القواعد والإرشادات التي تحكم إعداد القوائم المالية. من أهمها المعايير الدولية للتقارير المالية (IFRS) والمعايير المحاسبية الأمريكية (GAAP).",
        "ifrs": "المعايير الدولية للتقارير المالية (IFRS) هي مجموعة من المعايير المحاسبية الصادرة عن مجلس معايير المحاسبة الدولية (IASB)، وتستخدم في أكثر من 120 دولة حول العالم.",

        // الضرائب
        "ضريبة القيمة المضافة": "ضريبة القيمة المضافة هي ضريبة غير مباشرة تفرض على السلع والخدمات في كل مرحلة من مراحل الإنتاج والتوزيع. في المملكة العربية السعودية، تبلغ نسبتها 15%.",
        "الإقرار الضريبي": "الإقرار الضريبي هو مستند يقدمه المكلف للهيئة الضريبية يوضح فيه دخله وضرائبه المستحقة خلال فترة زمنية محددة.",
        "الزكاة": "الزكاة هي فريضة مالية إسلامية تفرض على الشركات والأفراد المسلمين. في السعودية، تخضع الشركات المملوكة بالكامل لمواطنين سعوديين أو خليجيين للزكاة بنسبة 2.5% من الوعاء الزكوي.",

        // خدمات محاسبية متخصصة
        "التدقيق الداخلي": "التدقيق الداخلي هو نشاط استشاري مستقل داخل المنشأة يهدف إلى تقييم وتحسين فعالية إدارة المخاطر والرقابة والحوكمة.",
        "التدقيق الخارجي": "التدقيق الخارجي هو فحص مستقل للقوائم المالية من قبل مدقق خارجي معتمد للتأكد من عدالة وصحة هذه القوائم وفقاً للمعايير المحاسبية.",
        "المراجعة المحدودة": "المراجعة المحدودة هي فحص أقل شمولاً من التدقيق الكامل، وتهدف إلى توفير تأكيد معتدل بأن القوائم المالية خالية من الأخطاء الجوهرية.",
        "الاستشارات الضريبية": "الاستشارات الضريبية تشمل تقديم المشورة للعملاء حول الامتثال الضريبي والتخطيط الضريبي وتقليل الالتزامات الضريبية بطرق قانونية.",

        // برامج محاسبية
        "برامج محاسبية": "نستخدم أحدث البرامج المحاسبية مثل SAP وOracle وQuickBooks وZoho Books لتقديم خدمات محاسبية دقيقة وفعالة لعملائنا."
    };

    // الاستجابة لاستفسارات محاسبية محددة
    const accountingQueries = {
        "كيف تسجل": (query) => {
            if (query.includes("مبيعات") || query.includes("إيرادات")) {
                return "لتسجيل المبيعات/الإيرادات، يتم عمل قيد محاسبي كالتالي:\n- مدين: النقدية أو المدينون (حسب طريقة البيع)\n- دائن: المبيعات/الإيرادات\nمع ضرورة تسجيل ضريبة القيمة المضافة إذا كانت المنشأة مسجلة في الضريبة.";
            } else if (query.includes("مشتريات") || query.includes("مصروفات")) {
                return "لتسجيل المشتريات/المصروفات، يتم عمل قيد محاسبي كالتالي:\n- مدين: المشتريات/المصروفات\n- دائن: النقدية أو الدائنون (حسب طريقة الشراء)\nمع ضرورة تسجيل ضريبة القيمة المضافة القابلة للخصم إذا كانت المنشأة مسجلة في الضريبة.";
            } else if (query.includes("أصول") || query.includes("أصل")) {
                return "لتسجيل شراء أصل ثابت، يتم عمل قيد محاسبي كالتالي:\n- مدين: الأصل الثابت (بالتكلفة)\n- دائن: النقدية أو الدائنون\nثم يتم احتساب الإهلاك دورياً بقيد:\n- مدين: مصروف الإهلاك\n- دائن: مجمع إهلاك الأصل";
            } else if (query.includes("رواتب")) {
                return "لتسجيل الرواتب، يتم عمل قيد محاسبي كالتالي:\n- مدين: مصروف الرواتب\n- دائن: الرواتب المستحقة أو النقدية\nمع مراعاة خصم التأمينات الاجتماعية وضريبة الدخل إن وجدت.";
            }
            return "لتسجيل أي معاملة مالية، يجب تطبيق نظام القيد المزدوج حيث يكون مجموع المدين = مجموع الدائن. يمكنك التواصل معنا للحصول على استشارة مفصلة حول تسجيل معاملاتك المحددة.";
        },
        "كيف احسب": (query) => {
            if (query.includes("ضريبة القيمة المضافة") || query.includes("ضريبة المضافة") || query.includes("vat")) {
                return "لحساب ضريبة القيمة المضافة (15% في السعودية):\n1. للإضافة على السعر: السعر × 0.15 = مبلغ الضريبة\n2. لاستخراج الضريبة من إجمالي المبلغ: المبلغ الإجمالي × (15 ÷ 115) = مبلغ الضريبة";
            } else if (query.includes("الزكاة")) {
                return "تحسب الزكاة بنسبة 2.5% من الوعاء الزكوي. الوعاء الزكوي = (حقوق الملكية + المخصصات طويلة الأجل + الالتزامات طويلة الأجل - الأصول غير المتداولة - الاستثمارات طويلة الأجل) مع إجراء بعض التعديلات حسب أنظمة هيئة الزكاة والضريبة والجمارك.";
            } else if (query.includes("الإهلاك") || query.includes("استهلاك")) {
                return "لحساب الإهلاك بطريقة القسط الثابت: (تكلفة الأصل - القيمة التخريدية) ÷ العمر الإنتاجي = قسط الإهلاك السنوي\nمثال: أصل تكلفته 100,000 ريال، قيمته التخريدية 10,000 ريال، وعمره الإنتاجي 10 سنوات، فإن قسط الإهلاك السنوي = (100,000 - 10,000) ÷ 10 = 9,000 ريال سنوياً.";
            } else if (query.includes("نسب مالية") || query.includes("نسبة مالية")) {
                return "من أهم النسب المالية:\n1. نسبة السيولة = الأصول المتداولة ÷ الالتزامات المتداولة\n2. نسبة الربحية = صافي الربح ÷ المبيعات\n3. نسبة المديونية = إجمالي الالتزامات ÷ إجمالي الأصول\n4. معدل دوران المخزون = تكلفة البضاعة المباعة ÷ متوسط المخزون";
            }
            return "لحساب أي نسبة أو قيمة محاسبية بدقة، يلزم معرفة تفاصيل أكثر. يمكنك التواصل معنا للحصول على استشارة مفصلة حول احتياجاتك المحددة.";
        },
        "ما هي": (query) => {
            // البحث في قاعدة المعرفة المحاسبية
            for (const term in accountingKnowledge) {
                if (query.includes(term)) {
                    return accountingKnowledge[term];
                }
            }
            return "هذا مصطلح محاسبي متخصص. للحصول على معلومات دقيقة حوله، يمكنك حجز استشارة مع أحد خبرائنا المحاسبين.";
        },
        "متى": (query) => {
            if (query.includes("تقديم الإقرار الضريبي") || query.includes("موعد الإقرار")) {
                return "مواعيد تقديم الإقرارات الضريبية في السعودية:\n- ضريبة القيمة المضافة: شهرياً أو ربع سنوياً حسب حجم الأعمال، خلال الشهر التالي للفترة الضريبية\n- ضريبة الدخل: سنوياً خلال 120 يوماً من نهاية السنة المالية\n- الزكاة: سنوياً خلال 120 يوماً من نهاية السنة المالية";
            } else if (query.includes("إعداد القوائم المالية") || query.includes("إصدار القوائم")) {
                return "يتم إعداد القوائم المالية عادةً في نهاية السنة المالية للمنشأة. كما يمكن إعداد قوائم مالية مرحلية (ربع سنوية أو نصف سنوية) حسب احتياجات المنشأة أو متطلبات الجهات الرقابية.";
            } else if (query.includes("الجرد")) {
                return "يتم إجراء الجرد الفعلي للمخزون عادةً في نهاية السنة المالية. ويمكن أيضاً إجراء جرد دوري خلال السنة للتأكد من سلامة المخزون ومطابقته للسجلات.";
            }
            return "المواعيد المحاسبية تختلف حسب نوع المنشأة وحجمها والمتطلبات القانونية. يمكنك التواصل معنا للحصول على معلومات دقيقة تناسب منشأتك.";
        }
    };

    // معلومات عامة عن المحاسبة للأسئلة المفتوحة
    const generalAccountingInfo = {
        "المحاسبة": `المحاسبة هي عملية تسجيل وتلخيص وتحليل وتفسير المعاملات المالية للمنشآت. تعتبر المحاسبة "لغة الأعمال" حيث تقدم معلومات مالية ضرورية لاتخاذ القرارات.

في شركة آفاق للمحاسبة، نقدم خدمات محاسبية متكاملة تشمل:
1. مسك الدفاتر المحاسبية (${services.accounting.price})
2. إعداد القوائم المالية وفق المعايير الدولية
3. الخدمات الضريبية والزكوية (${services.tax.price})
4. التدقيق والمراجعة (${services.audit.price})
5. الاستشارات المالية (${services.consulting.price})

فريقنا من المحاسبين المؤهلين يضمن دقة وجودة الخدمات المقدمة مع الالتزام بالمعايير المحاسبية المعتمدة.`,

        "القوائم المالية": `القوائم المالية هي تقارير توضح الوضع المالي للمنشأة ونتائج أعمالها خلال فترة زمنية محددة. تشمل القوائم المالية الأساسية:

1. قائمة المركز المالي (الميزانية العمومية): تعرض أصول والتزامات وحقوق ملكية المنشأة في تاريخ معين.
2. قائمة الدخل: توضح إيرادات ومصروفات المنشأة وصافي الربح أو الخسارة خلال فترة زمنية محددة.
3. قائمة التدفقات النقدية: توضح حركة النقد الداخل والخارج من المنشأة.
4. قائمة التغيرات في حقوق الملكية: توضح التغيرات في حقوق الملكية خلال فترة زمنية محددة.

في آفاق للمحاسبة، نقدم خدمات إعداد القوائم المالية وفق المعايير الدولية للتقارير المالية (IFRS) بدقة عالية وفي الوقت المناسب.`,

        "الضرائب": `الضرائب هي مبالغ مالية تفرضها الدولة على الأفراد والشركات. في المملكة العربية السعودية، تشمل الضرائب الرئيسية:

1. ضريبة القيمة المضافة (15%): تفرض على معظم السلع والخدمات.
2. ضريبة الدخل: تفرض على الشركات غير السعودية والأجنبية.
3. الزكاة: تفرض على الشركات السعودية والخليجية بنسبة 2.5% من الوعاء الزكوي.

في آفاق للمحاسبة، نقدم خدمات ضريبية متكاملة تشمل:
- التسجيل في ضريبة القيمة المضافة
- إعداد وتقديم الإقرارات الضريبية والزكوية
- التخطيط الضريبي
- تمثيل العملاء أمام هيئة الزكاة والضريبة والجمارك
- حل النزاعات الضريبية

سعر خدماتنا الضريبية يبدأ من ${services.tax.price}.`,

        "التدقيق": `التدقيق (المراجعة) هو فحص مستقل للقوائم المالية والسجلات المحاسبية للتأكد من صحتها وعدالتها وفقاً للمعايير المحاسبية المعتمدة.

أنواع التدقيق:
1. التدقيق الخارجي: يتم بواسطة مراجع خارجي مستقل.
2. التدقيق الداخلي: يتم بواسطة موظفين داخل المنشأة.
3. التدقيق الضريبي: يركز على الامتثال للأنظمة الضريبية.
4. تدقيق الأداء: يقيم كفاءة وفعالية العمليات.

في آفاق للمحاسبة، نقدم خدمات تدقيق شاملة بواسطة فريق من المراجعين المؤهلين بسعر يبدأ من ${services.audit.price}.`,

        "مسك الدفاتر": `مسك الدفاتر المحاسبية هو عملية تسجيل المعاملات المالية اليومية للمنشأة في السجلات المحاسبية.

تشمل عملية مسك الدفاتر:
1. تسجيل المعاملات المالية في دفتر اليومية
2. ترحيل القيود إلى دفتر الأستاذ
3. إعداد ميزان المراجعة
4. تسوية الحسابات البنكية
5. إدارة حسابات المدينين والدائنين
6. إعداد التقارير المالية الدورية

في آفاق للمحاسبة، نقدم خدمات مسك دفاتر محاسبية دقيقة وفعالة باستخدام أحدث البرامج المحاسبية بسعر يبدأ من ${services.accounting.price}.`,

        "الزكاة": `الزكاة هي فريضة مالية إسلامية تفرض على الشركات والأفراد المسلمين. في المملكة العربية السعودية، تخضع الشركات المملوكة بالكامل لمواطنين سعوديين أو خليجيين للزكاة بنسبة 2.5% من الوعاء الزكوي.

طريقة حساب الزكاة:
الوعاء الزكوي = (حقوق الملكية + المخصصات طويلة الأجل + الالتزامات طويلة الأجل - الأصول غير المتداولة - الاستثمارات طويلة الأجل) مع إجراء بعض التعديلات حسب أنظمة هيئة الزكاة والضريبة والجمارك.

في آفاق للمحاسبة، نقدم خدمات احتساب الزكاة وإعداد الإقرارات الزكوية وفقاً للأنظمة المعتمدة، مع ضمان الامتثال الكامل وتجنب الغرامات.`
    };

    // الاستجابة للأسئلة المفتوحة
    const openQuestions = {
        "ماذا تعرف عن": (query) => {
            for (const topic in generalAccountingInfo) {
                if (query.includes(topic)) {
                    return generalAccountingInfo[topic];
                }
            }

            // إذا لم يتم العثور على موضوع محدد
            return `كشركة متخصصة في المحاسبة، لدينا معرفة واسعة في مجالات المحاسبة المختلفة مثل:

1. مسك الدفاتر المحاسبية
2. إعداد القوائم المالية
3. الخدمات الضريبية والزكوية
4. التدقيق والمراجعة
5. الاستشارات المالية

هل تريد معلومات محددة عن أي من هذه المجالات؟ أو يمكنك طرح سؤال محدد حول موضوع محاسبي معين.`;
        },

        "ما هي": (query) => {
            // تم تعريفها سابقاً في accountingQueries
            // هنا نضيف معالجة إضافية للأسئلة المفتوحة
            for (const topic in generalAccountingInfo) {
                if (query.includes(topic)) {
                    return generalAccountingInfo[topic];
                }
            }

            // استخدام المعالجة السابقة إذا لم يتم العثور على إجابة هنا
            return null;
        },

        "اشرح لي": (query) => {
            for (const topic in generalAccountingInfo) {
                if (query.includes(topic)) {
                    return generalAccountingInfo[topic];
                }
            }

            // إذا لم يتم العثور على موضوع محدد
            return `يسعدني شرح المفاهيم المحاسبية لك. لتقديم شرح دقيق، يرجى تحديد الموضوع المحاسبي الذي ترغب في معرفة المزيد عنه، مثل:

- القيد المزدوج
- الميزانية العمومية
- قائمة الدخل
- التدفقات النقدية
- الإهلاك
- ضريبة القيمة المضافة
- الزكاة
- التدقيق المحاسبي

أو يمكنك اختيار أحد الخيارات أدناه للحصول على معلومات عن خدماتنا المحاسبية.`;
        },

        "عرفني": (query) => {
            for (const topic in generalAccountingInfo) {
                if (query.includes(topic)) {
                    return generalAccountingInfo[topic];
                }
            }

            // إذا لم يتم العثور على موضوع محدد
            return `يسعدني تعريفك بالمفاهيم المحاسبية. لتقديم تعريف دقيق، يرجى تحديد المصطلح المحاسبي الذي ترغب في معرفة المزيد عنه.

في شركة آفاق للمحاسبة، نقدم خدمات محاسبية متكاملة تشمل:
1. مسك الدفاتر المحاسبية (${services.accounting.price})
2. إعداد القوائم المالية
3. الخدمات الضريبية والزكوية (${services.tax.price})
4. التدقيق والمراجعة (${services.audit.price})
5. الاستشارات المالية (${services.consulting.price})

هل ترغب في معرفة المزيد عن أي من هذه الخدمات؟`;
        }
    };

    // الاتصال بنموذج Gemma مع تحسين الدقة المحاسبية
    async function simulateGemmaResponse(userMessage) {
        return new Promise((resolve) => {
            setTimeout(() => {
                const lowerMessage = userMessage.toLowerCase();

                // معالجة الأسئلة المفتوحة أولاً
                for (const questionType in openQuestions) {
                    if (lowerMessage.includes(questionType)) {
                        const response = openQuestions[questionType](lowerMessage);
                        if (response) {
                            resolve(response);
                            return;
                        }
                    }
                }

                // معالجة الاستفسارات المحاسبية المتخصصة
                for (const queryType in accountingQueries) {
                    if (lowerMessage.includes(queryType)) {
                        const response = accountingQueries[queryType](lowerMessage);
                        if (response) {
                            resolve(response);
                            return;
                        }
                    }
                }

                // البحث في قاعدة المعرفة المحاسبية
                for (const term in accountingKnowledge) {
                    if (lowerMessage.includes(term)) {
                        resolve(accountingKnowledge[term]);
                        return;
                    }
                }

                // البحث في المعلومات العامة عن المحاسبة
                for (const topic in generalAccountingInfo) {
                    if (lowerMessage.includes(topic)) {
                        resolve(generalAccountingInfo[topic]);
                        return;
                    }
                }

                // الاستجابة للكلمات المفتاحية العامة
                const keywords = {
                    'سعر': `أسعارنا تنافسية وتختلف حسب الخدمة:\n${Object.values(services).map(s => `${s.title}: ${s.price}`).join('\n')}`,
                    'خدمات': `نقدم خدمات محاسبية متكاملة تشمل:\n${Object.values(services).map(s => `- ${s.title}: ${s.description}`).join('\n')}`,
                    'تواصل': `يمكنك التواصل معنا عبر:\nهاتف: ${companyInfo.phone}\nواتساب: ${companyInfo.whatsapp}\nإيميل: ${companyInfo.email}`,
                    'موقع': `موقعنا في ${companyInfo.location}`,
                    'دوام': companyInfo.workHours,
                    'استشارة': 'يسعدنا تقديم استشارة محاسبية مجانية! يرجى ترك رقم جوالك وتفاصيل استفسارك المحاسبي وسنتواصل معك خلال 24 ساعة.',
                    'مرحبا': 'مرحباً بك في آفاق للمحاسبة! أنا مساعدك المحاسبي المتخصص. كيف يمكنني مساعدتك في استفساراتك المحاسبية والمالية اليوم؟',
                    'السلام': 'وعليكم السلام ورحمة الله وبركاته. أنا مساعد آفاق للمحاسبة المتخصص. كيف يمكنني مساعدتك في استفساراتك المحاسبية والمالية اليوم؟',
                    'زكاة': 'نقدم خدمات احتساب الزكاة وإعداد الإقرارات الزكوية وفقاً لأنظمة هيئة الزكاة والضريبة والجمارك في المملكة العربية السعودية. الزكاة تحسب بنسبة 2.5% من الوعاء الزكوي مع مراعاة الضوابط الشرعية والنظامية.',
                    'ضريبة': 'نقدم خدمات ضريبية متكاملة تشمل التسجيل في ضريبة القيمة المضافة، إعداد الإقرارات الضريبية، الاستشارات الضريبية، والتمثيل أمام الجهات الضريبية. نساعدك في تحقيق الامتثال الضريبي الكامل وتجنب الغرامات.',
                    'قوائم مالية': 'نقوم بإعداد القوائم المالية (الميزانية العمومية، قائمة الدخل، قائمة التدفقات النقدية، قائمة التغيرات في حقوق الملكية) وفقاً للمعايير المحاسبية المعتمدة، مع تقديم تحليل مالي شامل يساعدك في اتخاذ القرارات.',
                    'تدقيق': 'نقدم خدمات التدقيق والمراجعة بواسطة فريق من المحاسبين القانونيين المعتمدين، للتأكد من سلامة وعدالة القوائم المالية وفقاً للمعايير المهنية.',
                    'برنامج محاسبي': 'نساعدك في اختيار وتطبيق البرنامج المحاسبي المناسب لنشاطك، مع تقديم التدريب والدعم المستمر. نتعامل مع مختلف البرامج المحاسبية مثل SAP وOracle وQuickBooks وZoho Books.'
                };

                // البحث عن كلمات مفتاحية في رسالة المستخدم
                for (let keyword in keywords) {
                    if (lowerMessage.includes(keyword)) {
                        resolve(keywords[keyword]);
                        return;
                    }
                }

                // معالجة الأسئلة العامة عن المحاسبة
                if (lowerMessage.includes('محاسبة') || lowerMessage.includes('محاسب') || lowerMessage.includes('مالية') || lowerMessage.includes('مالي')) {
                    resolve(generalAccountingInfo["المحاسبة"]);
                    return;
                }

                // رد افتراضي محسن
                resolve(`كمساعد محاسبي متخصص في شركة آفاق للمحاسبة، يمكنني مساعدتك في مجموعة واسعة من الاستفسارات المحاسبية والمالية، مثل:

1. معلومات عن المحاسبة والمفاهيم المحاسبية
2. كيفية تسجيل المعاملات المحاسبية المختلفة
3. إعداد وتحليل القوائم المالية
4. الخدمات الضريبية والزكوية
5. التدقيق والمراجعة المحاسبية
6. الاستشارات المالية المتخصصة

يمكنك طرح سؤال محدد أو اختيار أحد الخيارات أدناه للحصول على معلومات أكثر تفصيلاً.`);
            }, 1000);
        });
    }
    </script>
</body>
</html>
